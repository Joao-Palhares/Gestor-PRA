/*
Deployment script for GestorDB

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "GestorDB"
:setvar DefaultFilePrefix "GestorDB"
:setvar DefaultDataPath "C:\Users\jonip\AppData\Local\Microsoft\Microsoft SQL Server Local DB\Instances\MSSQLLocalDB"
:setvar DefaultLogPath "C:\Users\jonip\AppData\Local\Microsoft\Microsoft SQL Server Local DB\Instances\MSSQLLocalDB"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Creating [dbo].[GetUsers]...';


GO
CREATE PROCEDURE [dbo].[GetUsers]
AS
BEGIN
	SELECT * FROM tblUsers
END
GO
PRINT N'Creating [dbo].[sp_AuthenticateUser]...';


GO
CREATE PROCEDURE [dbo].[sp_AuthenticateUser]
	@username varchar(50),
	@password char(64)

AS
BEGIN
	declare @countuser int

	Select @countuser = COUNT(*) From tblUsers Where username= @username

	IF(@countuser <> 0) -- verifica se o username está registado
		BEGIN
			
			declare @count int

			
					select @count = Count(*) from tblUsers where username = @username and password = @password
					END
END
GO
PRINT N'Creating [dbo].[sp_DeleteAlunoByID]...';


GO
CREATE PROCEDURE [dbo].[sp_DeleteAlunoByID]
	@id_aluno int

AS
begin
	declare @count int 
	SELECT @count = COUNT (*) from tblAlunos
	where id_aluno=@id_aluno
	if(@count=0)
		begin
			select -1 as ReturnCode
		End
	Else
	Begin
		Delete From tblAlunos where id_aluno=@id_aluno
		select 1 as ReturnCode
	END
END
GO
PRINT N'Creating [dbo].[sp_DeleteProfessorByID]...';


GO
CREATE PROCEDURE [dbo].[sp_DeleteProfessorByID]
	@id_professor int

AS
begin
	declare @count int 
	SELECT @count = COUNT (*) from tblProfessores
	where id_professor=@id_professor
	if(@count=0)
		begin
			select -1 as ReturnCode
		End
	Else
	Begin
		Delete From tblProfessores where id_professor=@id_professor
		select 1 as ReturnCode
	END
END
GO
PRINT N'Creating [dbo].[sp_DeleteUserByID]...';


GO
CREATE PROCEDURE [dbo].[sp_DeleteUserByID]
	@id_user int

AS
begin
	declare @count int 
	SELECT @count = COUNT (*) from tblUsers
	where id_user=@id_user
	if(@count=0)
		begin
			select -1 as ReturnCode
		End
	Else
	Begin
		Delete From tblUsers where id_user=@id_user
		select 1 as ReturnCode
	END
END
GO
PRINT N'Creating [dbo].[sp_GetAlunoByID]...';


GO
CREATE PROCEDURE [dbo].[sp_GetAlunoByID]
	@id_aluno int

AS
begin
		select * From tblAlunos where id_aluno=@id_aluno
END
GO
PRINT N'Creating [dbo].[sp_GetProfessorByID]...';


GO
CREATE PROCEDURE [dbo].[sp_GetProfessorByID]
	@id_professor int

AS
begin
		select * From tblProfessores where id_professor=@id_professor
END
GO
PRINT N'Creating [dbo].[sp_GetUserByEmail]...';


GO
CREATE PROCEDURE [dbo].[sp_GetUserByEmail]
	@email varchar(256)
AS
begin
		select * From tblUsers where email=@email
END
GO
PRINT N'Creating [dbo].[sp_GetUserByID]...';


GO
CREATE PROCEDURE [dbo].[sp_GetUserByID]
	@id_user int

AS
begin
		select * From tblUsers where id_user=@id_user
END
GO
PRINT N'Creating [dbo].[sp_InsertAluno]...';


GO
CREATE PROCEDURE [dbo].[sp_InsertAluno]
	@n_processo int,
	@nome char(64),
	@data_nascimento date,
	@id_curso int,
	@id_turma int,
	@numero int
AS
Begin
	Declare @count int
	SELECT @count= COUNT(id_aluno) FROM tblAlunos Where n_processo=@n_processo

	IF(@count<>0)
	begin 
		select -1 as ReturnCode
	End
	Begin
		Insert INTO [dbo].[tblAlunos]
				([n_processo],
				[nome],
				[data_nascimento],
				[id_curso],
				[id_turma])
		Values (@n_processo,@nome,@data_nascimento,@id_curso,@id_turma)
		select 1 as ReturnCode
	END
END
GO
PRINT N'Creating [dbo].[sp_InsertProfessor]...';


GO
CREATE PROCEDURE [dbo].[sp_InsertProfessor]
	@nome char(64),
	@data_nascimento date,
	@dt varchar(10)

AS
Begin
	Declare @count int
	SELECT @count= COUNT(id_professor) FROM tblProfessores Where nome=@nome

	IF(@count<>0)
	begin 
		select -1 as ReturnCode1
	End
	Begin
		Insert INTO [dbo].[tblProfessores]
				([nome],
				[data_nascimento],
				[dt])
		Values (@nome,@data_nascimento,@dt)
		select 1 as ReturnCode1
	END
END
GO
PRINT N'Creating [dbo].[sp_InsertUser]...';


GO
CREATE PROCEDURE [dbo].[sp_InsertUser]
	@username varchar(50),
	@password char(64),
	@email varchar(256),
	@role char(1) = 'U'
AS
Begin
	Declare @count int
	SELECT @count= COUNT(id_user) FROM tblUsers Where username=@username

	IF(@count<>0)
	begin 
		select -1 as ReturnCode
	End
	Begin
		Insert INTO [dbo].[tblUsers]
				([username],
				[password],
				[email],
				[role])
		Values (@username,@password,@email,@role)
		select 1 as ReturnCode
	END
END
GO
PRINT N'Creating [dbo].[sp_UpdateAlunoByID]...';


GO
CREATE PROCEDURE [dbo].[sp_UpdateAlunoByID]
	@id_aluno int,
	@n_processo varchar(50),
	@nome char(64),
	@data_nascimento date,
	@id_curso int,
	@id_turma int,
	@numero int

AS
begin
	declare @count int 
	SELECT @count = COUNT (*) from tblAlunos
	where id_aluno=@id_aluno

	if(@count=0)
		begin
			select -1 as ReturnCode
		End
	Else
	Begin
		update tblAlunos 
		set n_processo=@n_processo , nome=@nome , data_nascimento = @data_nascimento, id_curso = @id_curso, id_turma= @id_turma, numero= @numero
		where id_aluno=@id_aluno
		select 1 as ReturnCode
	END
END
GO
PRINT N'Creating [dbo].[sp_UpdateProfessorByID]...';


GO
CREATE PROCEDURE [dbo].[sp_UpdateProfessorByID]
	@id_professor int,
	@nome char(100),
	@data_nascimento date,
	@dt varchar(100)

AS
begin
	declare @count int 
	SELECT @count = COUNT (*) from tblProfessores
	where id_professor=@id_professor

	if(@count=0)
		begin
			select -1 as ReturnCode
		End
	Else
	Begin
		update tblProfessores 
		set nome=@nome , data_nascimento=@data_nascimento, dt=@dt
		where id_professor=@id_professor
		select 1 as ReturnCode
	END
END
GO
PRINT N'Creating [dbo].[sp_UpdateUserByID]...';


GO
CREATE PROCEDURE [dbo].[sp_UpdateUserByID]
	@id_user int,
	@username varchar(50),
	@password char(64),
	@role char(1)
AS
begin
	declare @count int 
	SELECT @count = COUNT (*) from tblUsers
	where id_user=@id_user

	if(@count=0)
		begin
			select -1 as ReturnCode
		End
	Else
	Begin
		update tblUsers 
		set username=@username , password=@password , role=@role
		where id_user=@id_user
		select 1 as ReturnCode
	END
END
GO
PRINT N'Update complete.';


GO
